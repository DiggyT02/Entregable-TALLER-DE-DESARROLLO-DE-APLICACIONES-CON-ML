<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <!-- Bootstrap -->
    <link rel="stylesheet" href="   https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css">
    
    <!-- CDN librerias -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.11.10/p5.min.js"></script>
    <script src="https://unpkg.com/ml5@1/dist/ml5.min.js"></script>
</head>
<body>
    <main>
        <section>
            <div class="container mt-5">
                <div id="form-container">
                    <h2 class="fw-lighter">Inserte una imagen para comenzar</h2>
                    <div class="border"></div>
                    <form id="form-img">
                        <div class="form-control mt-2">
                            <input type="file" id="fileInput" accept="image/*" class="form-control" required />
                        </div>
                        <div class="text-end mt-2">
                            <button type="submit" class="btn btn-primary" id="btn-submit">
                                Enviar
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Contenedor que estará oculto al principio -->
                <div class="display-flex visually-hidden" id="container-results">
                    <h2>Imagen</h2>
                    <div class="border" id="contenedor"></div>
                    <div>
                        <div class="form-control mt-2" id="caja1">
                            <label for="" id="label-1">resultado:1</label>
                        </div>
                        <div class="form-control mt-2" id="caja2">
                            <label for="" id="label-2">resultado:2</label>
                        </div>
                        <div class="form-control mt-2" id="caja3">
                            <label for="" id="label-3">resultado:3</label>
                        </div>
                    </div>
                    <div class="mt-3">
                        <button class="btn btn-secondary" id="btn-clear">Limpiar</button>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- CDN BOOTSTRAP  -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
    <!-- CDN SWEET ALERT  -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        /* Formulario */
        const form = document.getElementById("form-img");
        /* Contanedor de los resultados */
        const containerResults = document.querySelector("#container-results");
        
        /* Labels para los resultados */
        const label1 = document.getElementById('label-1');
        const label2 = document.getElementById('label-2');
        const label3 = document.getElementById('label-3');
        
        /* Contendores de los resultados(loadBar) */
        const caja1 = document.querySelector("#caja1");
        const caja2 = document.querySelector("#caja2");
        const caja3 = document.querySelector("#caja3");

        /* Boton para limpiar los reslutados */
        const btnClear = document.getElementById('btn-clear');

        let classifier;
        let img;
        let canvas;

        /* Oculatamos el contenedor de los resultados con el canvas */
        containerResults.classList.add('visually-hidden');

        // Cargamos el modelo
        function preload() {
            classifier = ml5.imageClassifier("MobileNet", modelLoaded);
        }

        // mostramos el sweetAlert
        function modelLoaded() {
            Swal.fire({
                title: '¡Modelo Cargado!',
                text: 'El modelo MobileNet está listo para clasificar imágenes.',
                icon: 'success',
                confirmButtonText: '¡Listo!'
            });
        }

        // cargamos los datos
        function setup() {
            canvas = createCanvas(400, 400);
            canvas.parent('contenedor');
            
            const fileInput = document.getElementById('fileInput');
            fileInput.addEventListener('change', handleFileSelect);

            classifier = ml5.imageClassifier('MobileNet');
        }

        // manejamos la inserccion de una imagen
        function handleFileSelect(event) {
            const file = event.target.files[0];
            
            if (file) {
                const imgURL = URL.createObjectURL(file);
                img = loadImage(imgURL, () => {
                    image(img, 0, 0, width, height);
                    classifier.classify(img, gotResult);
                });
            }
        }

        // Crear la barra de progreso con el texto
        function createBar(value, labelText, clase) {
            const container = document.createElement("div");
            const bar = document.createElement("div");
            const label = document.createElement("label");

            container.classList.add('progress');
            container.setAttribute('aria-valuenow', value);
            container.setAttribute('aria-valuemin', '0');
            container.setAttribute('aria-valuemax', '100');
            
            bar.classList.add('progress-bar');
            bar.classList.add(clase);
            bar.style.width = `${parseInt(value)}%`;

            label.innerText = labelText;
            label.classList.add('progress-label');  
            bar.appendChild(label);

            container.appendChild(bar);
            return container;
        }

        // Mostrar resultados
        function gotResult(results) {
            caja1.innerHTML = '';
            caja2.innerHTML = '';
            caja3.innerHTML = '';

            const res1 = nf(results[0].confidence, 0, 2) * 100;
            const res2 = nf(results[1].confidence, 0, 2) * 100;
            const res3 = nf(results[2].confidence, 0, 2) * 100;

            const label1Text = `${results[0].label} : ${res1}%`;
            const label2Text = `${results[1].label} : ${res2}%`;
            const label3Text = `${results[2].label} : ${res3}%`;

            const bar1 = createBar(res1, label1Text, 'text-bg-success');
            const bar2 = createBar(res2, label2Text, 'text-bg-warning');
            const bar3 = createBar(res3, label3Text, 'text-bg-danger');

            caja1.appendChild(bar1);
            caja2.appendChild(bar2);
            caja3.appendChild(bar3);

            // Mostramos el contenedor con los resultados
            containerResults.classList.remove('visually-hidden');
        }

        form.addEventListener("submit", (e) => {
            e.preventDefault();  // Evitar el envío del formulario
        });
        
        btnClear.addEventListener('click', () => {
            caja1.innerHTML = '';
            caja2.innerHTML = '';
            caja3.innerHTML = '';
            containerResults.classList.add('visually-hidden');
            document.getElementById('fileInput').value = ''; // Limpiar el input de archivo
        });

        // Inicializar todo
        preload();
        setup();
    </script> 
</body>
</html>