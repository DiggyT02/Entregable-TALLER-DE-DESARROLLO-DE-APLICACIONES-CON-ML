<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Actividad 2 - Login con dibujo</title>
    <link rel="stylesheet" href="styles.css" />
    <!-- Bootstrap -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <!-- p5.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.11.10/p5.min.js"></script>
    <!-- ML5.js -->
    <script src="https://unpkg.com/ml5@1/dist/ml5.min.js"></script>
    
  </head>
  <body>
    <div class="container">
      <h1>Actividad 2: Login seguro</h1>
      <form id="loginForm">
        <input
          type="text"
          id="username"
          placeholder="Usuario"
          required
        /><br /><br />
        <input
          type="password"
          id="password"
          placeholder="Contrase√±a"
          required
        /><br /><br />
        <div class="d-flex  justify-content-center flex-column">
          <label for="" class="fw-ligther fs-2">Dibuje su clave</label>
          <!-- Contenedor del canvas -->
          <div id="container-canvas" class="">
            <canvas id="canvas" class="border border-danger"></canvas>
          </div>

          <div class="" id="results-container">
            <!-- Resultados cargados del modelo -->
          </div>
        </div>
        <button type="button" onclick="clearCanvas()">Reintentar</button
        ><br /><br />
        <button type="submit">Iniciar sesi√≥n</button>
      </form>
      <p id="message"></p>
      <a href="index.html">‚Üê Volver</a>
    </div>

    <script>
      let clasifier; // para el clasificador
      let clearButton; // para el boton de limpiar

      let result = document.querySelector("#result"); // Donde se almacenara el resultado
      
      const canvas = document.querySelector("#canvas");
      //let canvas;

      /* Objeto para manejar las credenciales de los usuarios */
      const usuarios = {
        diggy: {
          contrasenia: "1234",
          codigo: "sun",
        },
        ayala: {
          contrasenia: "romo",
          codigo: "chair",
        },
        tony: {
          contrasenia: "felix",
          codigo: "tree",
        },
      };

      /* Cargamos el modelo */
      function preload() {
        clasifier = ml5.imageClassifier("DoodleNet");
      }

      /* realizamos la prediccion del dibujo */
      function setup() {
        createCanvas(280, 280, canvas);
        background(255);
        console.log(canvas)

        //canvas.parent("container-canvas");
        //Identificacion en tiempo real
        clasifier.classifyStart(canvas, gotResult);

        resultsDiv = createDiv("Calculando...");
        resultsDiv.parent("results-container");

      }

      /* Obtenemos los resultados */
      function gotResult(results) {
        //console.log(results)
        let label = results[0].label;
        let confidence = results[0].confidence;
        
        resultsDiv.html(label + " - " + confidence);
      }

      //solo dibuja si se hace click
      function draw() {
        strokeWeight(16); //Grosor l√°piz
        stroke(0); //Color del trazo

        if (mouseIsPressed) {
          //p = pressed
          line(pmouseX, pmouseY, mouseX, mouseY);
        }
      }

      //Limpia el canvas
      function clearCanvas() {
        background(255);
      }
/* 
      function checkLogin(user, pass, draw) {
        if (usuarios[user] && usuarios[user].contrasenia === pass) {
          const codigoEsperado = usuarios[user].codigo;
          if (dibujo === codigoEsperado) {
            return true; // Login exitoso
          }
        }
        return false; // Login fallido
        
      } */

      // Envio del formulario
      document.getElementById("loginForm").addEventListener("submit", function (e) {
          e.preventDefault();
          const user = document.getElementById("username").value;
          const pass = document.getElementById("password").value;
          const message = document.getElementById("message");

          const canvasData = canvas.toDataURL();
          const hasDrawing =
            canvasData !== "data:," && !canvasData.includes("blank");

          if (usuarios[user] && usuarios[user] === pass && hasDrawing) {
            message.style.color = "#2ecc71";
            message.innerHTML = `¬°Login exitoso! Bienvenid@ <strong>${user}</strong> üéâ`;
          } else {
            message.style.color = "#e74c3c";
            if (!hasDrawing) {
              message.innerHTML =
                "Debes realizar un dibujo para iniciar sesi√≥n.";
            } else if (!usuarios[user]) {
              message.innerHTML = "Usuario no encontrado.";
            } else {
              message.innerHTML = "Contrase√±a incorrecta o dibujo faltante.";
            }
          }
        });
    
    </script>
  </body>
</html>
