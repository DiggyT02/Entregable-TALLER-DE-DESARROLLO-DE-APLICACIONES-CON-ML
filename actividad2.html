<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Actividad 2 - Login con dibujo</title>
    <link rel="stylesheet" href="styles.css" />
    <!-- Bootstrap -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <!-- p5.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.11.10/p5.min.js"></script>
    <!-- ML5.js -->
    <script src="https://unpkg.com/ml5@1/dist/ml5.min.js"></script>

    <!-- SWEET ALERT -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  </head>
  <body>
    <div class="container">
      <h1 class="fw-light">Actividad 2: Login seguro</h1>
      <form id="loginForm">
        <input
          type="text"
          id="username"
          placeholder="Usuario"
          required
        /><br /><br />
        <input
          type="password"
          id="password"
          placeholder="Contraseña"
          required
        /><br /><br />
        <div class="d-flex justify-content-center flex-column">
          <label for="" class="fw-ligther fs-2">Dibuje su clave</label>
          <!-- Contenedor del canvas -->
          <div id="container-canvas" class="">
            <canvas id="canvas" class="border border-primary"></canvas>
          </div>

          <div class="" id="results-container">
            <!-- Resultados cargados del modelo -->
          </div>
        </div>
        <button type="button" class="btn btn-secondary" onclick="clearCanvas()">
          Reintentar</button
        ><br /><br />
        <button type="submit" class="btn btn-primary">Iniciar sesión</button>
      </form>
      <p id="message"></p>
      <a href="index.html">← Volver</a>
    </div>

    <script>
      let clasifier; // para el clasificador
      let clearButton; // para el boton de limpiar

      /*  let result = document.querySelector("#result"); // Donde se almacenara el resultado */
      let label;
      let confidence;

      const canvas = document.querySelector("#canvas");
      //let canvas;

      /* Objeto para manejar las credenciales de los usuarios */
      const usuarios = {
        diggy: {
          contrasenia: "1234",
          dibujo: "sun",
        },
        ayala: {
          contrasenia: "romo",
          dibujo: "chair",
        },
        tony: {
          contrasenia: "felix",
          dibujo: "tree",
        },
      };

      /* Cargamos el modelo */
      function preload() {
        clasifier = ml5.imageClassifier("DoodleNet");
      }

      /* realizamos la prediccion del dibujo */
      function setup() {
        createCanvas(280, 280, canvas);
        background(255);
        console.log(canvas);

        //canvas.parent("container-canvas");
        //Identificacion en tiempo real
        clasifier.classifyStart(canvas, gotResult);

        resultsDiv = createDiv("Calculando...");
        resultsDiv.parent("results-container");
      }

      /* Obtenemos los resultados */
      function gotResult(results) {
        //console.log(results)
        label = results[0].label;
        confidence = nf(results[0].confidence, 0, 2) * 100;

        resultsDiv.html(label + " - " + confidence);
      }

      //solo dibuja si se hace click
      function draw() {
        strokeWeight(16); //Grosor lápiz
        stroke(0); //Color del trazo

        if (mouseIsPressed) {
          //p = pressed
          line(pmouseX, pmouseY, mouseX, mouseY);
        }
      }

      //Limpia el canvas
      function clearCanvas() {
        background(255);
      }

      function checkLogin(user, pass, draw) {
        /* Validacion para el dibujo */
        if (!draw) {
          return false; // No hay dibujo
        }

        /* Convertimos los parametros en tipo String para compararlos */
        const usuarioString = String(user);
        const passString = String(pass);
        const dibujo = String(draw);
        console.log(usuarioString, passString, dibujo);

        /* Verificamos las credenciales */
        if (usuarioString in usuarios) {
          //Verificamos el usuario se encuentra en la BD :D
          if (usuarios[usuarioString].contrasenia === passString) {
            if (usuarios[usuarioString].dibujo === dibujo) {
              return true; // Login exitoso
            } else {
              return false; // Dibujo incorrecto
            }
          } else {
            return false; // Contraseña incorrecta
          }
        }

        return false; // Login fallido
      }

      // Envio del formulario
      document.getElementById("loginForm").addEventListener("submit", function (e) {
          e.preventDefault();
          const user = document.getElementById("username").value;
          const pass = document.getElementById("password").value;
          const message = document.getElementById("message");

          /* Obtenemos los resultados */
          confidence = parseInt(confidence);
          label = String(label);

          if (confidence >= 70) {
            return checkLogin(user, pass, label) ? bienvenido(user) : invalidCredentials();
          } else {
            Swal.fire({
              icon: "error",
              title: "Dibuje Irreconocible",
              text: "Dibuje su codigo bien porfavor",
            });
            
            console.log("dibujo irreconocible");
            return false; // Dibujo no reconocido
          }
        });
        
        function bienvenido(nombre) {
          window.location.href = `bienvenido.html?nombre=${encodeURIComponent(
            nombre
          )}`;
          window.open("/bienvenido.html", "_blank");
        }
        
        function invalidCredentials(){
          Swal.fire({
            icon: "error",
            title: "Usuario o Contrasenia Incorrectos",
            text: "Verifique su usuario y su contrasenia porfvaor",
          });
        }

    </script>
  </body>
</html>
